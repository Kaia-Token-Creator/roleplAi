<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Uncensored Test Chat</title>
  <style>
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:#0b0f14; color:#e8eef6;}
    .wrap{max-width:760px; margin:0 auto; padding:14px;}
    .top{display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:10px;}
    .badge{font-size:12px; padding:6px 10px; border:1px solid #2a3647; border-radius:999px; background:#111a24; color:#cfe3ff;}
    .btn{cursor:pointer; border:1px solid #2a3647; background:#111a24; color:#e8eef6; padding:8px 10px; border-radius:10px; font-size:13px;}
    .btn:active{transform:translateY(1px);}
    .panel{border:1px solid #2a3647; border-radius:14px; overflow:hidden; background:#0f1620;}
    .chat{height:64vh; overflow:auto; padding:12px; display:flex; flex-direction:column; gap:10px;}
    .msg{max-width:85%; padding:10px 12px; border-radius:14px; line-height:1.35; font-size:14px; white-space:pre-wrap; word-break:break-word;}
    .me{align-self:flex-end; background:#223044; border:1px solid #2a3647;}
    .ai{align-self:flex-start; background:#101a2a; border:1px solid #233145;}
    .sys{align-self:center; background:#0b0f14; border:1px dashed #2a3647; opacity:.9; font-size:12px;}
    .bar{display:flex; gap:8px; padding:10px; border-top:1px solid #2a3647; background:#0b0f14;}
    textarea{flex:1; resize:none; height:44px; max-height:140px; padding:10px 12px; border-radius:12px; border:1px solid #2a3647; outline:none; background:#0f1620; color:#e8eef6; font-size:14px;}
    .hint{font-size:12px; opacity:.75; margin-top:8px;}
    code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="badge">Local Uncensored Test · <span id="apiUrl"></span></div>
      <div style="display:flex; gap:8px;">
        <button class="btn" id="btnInit">Init</button>
        <button class="btn" id="btnClear">Clear</button>
      </div>
    </div>

    <div class="panel">
      <div id="chat" class="chat"></div>
      <div class="bar">
        <textarea id="input" placeholder="Type a message… (Enter = send, Shift+Enter = newline)"></textarea>
        <button class="btn" id="btnSend">Send</button>
      </div>
    </div>

    <div class="hint">
      Sends <code>{ tier:"uncensored", paymentStatus:"paid" }</code> to <code>/api/chat</code>.  
      For private/local testing only.
    </div>
  </div>

<script>
(() => {
  const API = "/api/chat"; // same-origin Cloudflare Pages Function
  const chatEl = document.getElementById("chat");
  const inputEl = document.getElementById("input");
  const apiUrlEl = document.getElementById("apiUrl");
  const btnSend = document.getElementById("btnSend");
  const btnInit = document.getElementById("btnInit");
  const btnClear = document.getElementById("btnClear");

  apiUrlEl.textContent = API;

  // --- minimal "session" ---
  const session = {
    tier: "uncensored",
    paymentStatus: "paid",
    character: {
      name: "taeri",
      age: 22,
      gender: "female",
      language: "English",
      personality: "Playful, flirty, sharp-tongued, confident. Keeps replies short and chatty.",
      scenario: "A private chat that starts mid-conversation. There is already a spark.",
      nickname: "baby"
    },
    history: []
  };

  function addMsg(role, text){
    const div = document.createElement("div");
    div.className = "msg " + (role === "user" ? "me" : role === "assistant" ? "ai" : "sys");
    div.textContent = text;
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function saveHistory(role, content){
    session.history.push({ role, content });
    // keep it light for your server limits
    if (session.history.length > 20) session.history = session.history.slice(-20);
  }

  async function post(payload){
    const res = await fetch(API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      const msg = data?.error ? `${data.error}${data.detail ? " " + data.detail : ""}` : `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return data;
  }

  async function initChat(){
    addMsg("system", "Init sent.");
    const payload = {
      init: true,
      tier: "uncensored",
      paymentStatus: "paid",
      character: session.character
    };
    const data = await post(payload);
    if (data?.reply) {
      addMsg("assistant", data.reply);
      saveHistory("assistant", data.reply);
    } else {
      addMsg("system", "No reply from init.");
    }
  }

  async function sendChat(){
    const text = inputEl.value.trim();
    if (!text) return;
    inputEl.value = "";
    addMsg("user", text);
    saveHistory("user", text);

    btnSend.disabled = true;
    btnSend.textContent = "…";

    try{
      const payload = {
        tier: "uncensored",
        paymentStatus: "paid",
        character: session.character,
        message: text,
        history: session.history
      };
      const data = await post(payload);
      const reply = String(data?.reply || "").trim();
      if (reply) {
        addMsg("assistant", reply);
        saveHistory("assistant", reply);
      } else {
        addMsg("system", "Empty reply.");
      }
    }catch(e){
      addMsg("system", "Error: " + (e?.message || e));
    }finally{
      btnSend.disabled = false;
      btnSend.textContent = "Send";
      inputEl.focus();
    }
  }

  btnInit.addEventListener("click", initChat);
  btnSend.addEventListener("click", sendChat);
  btnClear.addEventListener("click", () => {
    session.history = [];
    chatEl.innerHTML = "";
    addMsg("system", "Cleared.");
    inputEl.focus();
  });

  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      sendChat();
    }
  });

  // optional: auto init on load
  addMsg("system", "Ready. Click Init or just start typing.");
})();
</script>
</body>
</html>
