<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Stitch | roleplay-chat.com</title>
  <meta name="theme-color" content="#000000" />

  <!-- Fonts (same as main) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg:#000;
      --fg:#fff;
      --muted:rgba(255,255,255,.75);
      --muted2:rgba(255,255,255,.55);
      --card:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.14);
      --shadow: 0 14px 36px rgba(0,0,0,.55);
      --radius2: 22px;

      --gold:#ffcc00;
      --good:#36d399;
      --bad:#ff6b6b;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }

    body{
      background:
        radial-gradient(900px 600px at 10% 0%, rgba(255,255,255,.06), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(255,255,255,.05), transparent 60%),
        var(--bg);
      color: var(--fg);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.35;
    }

    a{ color:inherit; }

    .wrap{
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding: 18px 14px 26px;
    }

    .shell{
      width: min(860px, 100%);
      display:grid;
      gap: 14px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 4px 6px 0;
      gap: 12px;
    }

    .logo{
      text-decoration: none;
      font-family: "Baloo 2", Inter, sans-serif;
      font-weight: 700;
      letter-spacing: .3px;
      font-size: clamp(16px, 3.6vw, 24px);
      padding: 5px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 22px rgba(0,0,0,.45);
      user-select:none;
      white-space: nowrap;
    }

    .logoRole{ color: #ffcc00; }
    .logoDot{
      color: rgba(255,255,255,.95);
      font-size: 0.5em;
      vertical-align: baseline;
    }

    .shareWrap{
      display: flex;
      align-items: center;
      gap: 6px;
      position: relative;
    }

    .bookmarkHint{
      font-size: 10px;
      line-height: 1.1;
      text-align: right;
      color: rgba(255,255,255,.55);
      user-select: none;
      white-space: nowrap;
    }

    .shareBtn{
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:.15s ease;
      flex: 0 0 auto;
      padding: 0;
    }
    .shareBtn:hover{ background: rgba(255,255,255,.10); transform: translateY(-1px); }
    .shareBtn:active{ transform: translateY(0px); }

    .shareBtn svg{
      width: 16px;
      height: 16px;
      fill: none;
      stroke: rgba(255,255,255,.92);
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    /* ✅ Info button: yellow glow */
    #infoBtn{
      border-color: rgba(255, 204, 0, .55);
      box-shadow:
        0 0 0 1px rgba(255, 204, 0, .25),
        0 0 18px rgba(255, 204, 0, .35),
        0 0 34px rgba(255, 204, 0, .22),
        var(--shadow);
    }
    #infoBtn:hover{
      border-color: rgba(255, 204, 0, .75);
      box-shadow:
        0 0 0 1px rgba(255, 204, 0, .35),
        0 0 22px rgba(255, 204, 0, .45),
        0 0 44px rgba(255, 204, 0, .28),
        var(--shadow);
    }

    .infoMenu{
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      min-width: 220px;
      background: rgba(10,10,10,.92);
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 6px;
      display: none;
      z-index: 99999;
    }
    .infoMenu.active{ display: block; }

    .infoMenu a{
      display: block;
      padding: 10px 10px;
      border-radius: 12px;
      text-decoration: none;
      color: rgba(255,255,255,.92);
      font-size: 13px;
    }
    .infoMenu a:hover{ background: rgba(255,255,255,.08); }

    .sub{
      text-align:center;
      margin-top: 0px;
      color: var(--muted);
      font-size: 12px;
    }

    /* =========================
       Stitch page (new content)
    ========================= */

    .panel{
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .panelInner{
      padding: 14px 12px 12px;
      display: grid;
      gap: 10px;
    }

    .heroTitle{
      text-align: center;
      font-family: "Baloo 2", Inter, sans-serif;
      font-weight: 700;
      letter-spacing: .2px;
      font-size: clamp(18px, 4.3vw, 28px);
      margin: 2px 0 0;
    }

    .heroTitle .stitch{
      color: var(--gold);
      text-shadow:
        0 0 12px rgba(255,204,0,.22),
        0 0 24px rgba(255,204,0,.12);
    }

    .heroSub{
      text-align: center;
      color: rgba(255,255,255,.72);
      font-size: 12px;
      margin-top: -2px;
    }

    .chatLink{
      text-align: center;
      font-size: 13px;
      color: rgba(255,255,255,.88);
    }
    .chatLink a{
      text-decoration: none; /* no underline */
      color: rgba(255,204,0,.95);
      font-weight: 700;
      padding: 2px 4px;
      border-radius: 8px;
      background: rgba(255,204,0,.10);
      border: 1px solid rgba(255,204,0,.22);
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
      transition: .15s ease;
    }
    .chatLink a:hover{
      transform: translateY(-1px);
      background: rgba(255,204,0,.14);
      border-color: rgba(255,204,0,.30);
    }

    .hintRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-top: 1px solid rgba(255,255,255,.08);
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
    }

    .miniHint{
      color: rgba(255,255,255,.70);
      font-size: 12px;
      line-height: 1.25;
    }
    .miniHint b{ color: rgba(255,255,255,.92); }

    .statusPill{
      font-size: 11px;
      color: rgba(255,255,255,.88);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      white-space: nowrap;
    }

    /* Slots: desktop = horizontal, mobile = grid */
    .slotsWrap{
      padding: 10px 12px 12px;
    }

    .slots{
      display:flex;
      gap: 10px;
      overflow-x:auto;
      padding-bottom: 2px;
      scrollbar-width: thin;
    }

    .slot{
      width: 160px;
      height: 118px;
      border-radius: 18px;
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
      position: relative;
      flex: 0 0 auto;
      cursor: pointer;
      user-select:none;
      overflow: hidden;
      transition:.15s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 10px;
    }
    .slot:hover{ background: rgba(255,255,255,.06); transform: translateY(-1px); }
    .slot.dragover{
      border-color: rgba(255,204,0,.65);
      box-shadow:
        0 0 0 1px rgba(255,204,0,.25),
        0 0 18px rgba(255,204,0,.22),
        0 10px 22px rgba(0,0,0,.35);
    }

    .slotNum{
      position:absolute;
      top: 10px;
      left: 10px;
      font-size: 12px;
      color: rgba(255,255,255,.28);
      font-weight: 700;
    }

    .slotPlus{
      font-size: 30px;
      line-height: 1;
      color: rgba(255,255,255,.55);
      font-weight: 800;
    }

    .slotLabel{
      font-size: 12px;
      color: rgba(255,255,255,.65);
      line-height: 1.25;
    }

    .thumb{
      position:absolute;
      inset:0;
      background-size: cover;
      background-position: center;
      filter: contrast(1.05) saturate(1.05);
      opacity: 1;
    }
    .thumbOverlay{
      position:absolute;
      inset:0;
      background:
        linear-gradient(to top, rgba(0,0,0,.86), rgba(0,0,0,.10) 55%, rgba(0,0,0,.25));
    }

    .fileMeta{
      position:absolute;
      left: 10px;
      right: 10px;
      bottom: 9px;
      display:flex;
      gap: 8px;
      align-items:flex-end;
      justify-content:space-between;
    }
    .fileName{
      font-size: 11px;
      color: rgba(255,255,255,.88);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 120px;
    }
    .removeBtn{
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.85);
      width: 28px;
      height: 28px;
      border-radius: 10px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:.15s ease;
    }
    .removeBtn:hover{ background: rgba(255,107,107,.14); border-color: rgba(255,107,107,.32); }

    .actions{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      padding: 12px;
      border-top: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
      flex-wrap: wrap;
    }

    .primaryBtn{
      appearance:none;
      border: 1px solid rgba(255,204,0,.36);
      background: rgba(255,204,0,.12);
      color: rgba(255,255,255,.92);
      font-weight: 800;
      letter-spacing: .2px;
      padding: 10px 14px;
      border-radius: 14px;
      cursor:pointer;
      box-shadow:
        0 0 0 1px rgba(255,204,0,.12),
        0 10px 24px rgba(0,0,0,.45);
      transition:.15s ease;
      display:flex;
      align-items:center;
      gap: 8px;
      min-width: 160px;
      justify-content:center;
    }
    .primaryBtn:hover{ transform: translateY(-1px); background: rgba(255,204,0,.16); }
    .primaryBtn:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none !important;
    }

    .ghostBtn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.82);
      font-weight: 700;
      padding: 10px 14px;
      border-radius: 14px;
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      transition:.15s ease;
    }
    .ghostBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.06); }

    .progressLine{
      width: 100%;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      overflow:hidden;
      display:none;
    }
    .progressLine.active{ display:block; }
    .progressFill{
      height: 100%;
      width: 0%;
      background: rgba(255,204,0,.55);
      border-radius: 999px;
      transition: width .12s linear;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(10,10,10,.88);
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: var(--shadow);
      border-radius: 14px;
      padding: 10px 12px;
      color: rgba(255,255,255,.92);
      font-size: 13px;
      display:none;
      z-index: 999999;
      max-width: min(520px, calc(100vw - 24px));
    }
    .toast.show{ display:block; }
    .toast b{ color: var(--gold); }

    .finePrint{
      color: rgba(255,255,255,.55);
      font-size: 11px;
      padding: 0 12px 12px;
      line-height: 1.3;
    }

    /* Mobile: make slots a 2x grid when tight */
    @media (max-width: 640px){
      .slots{
        display:grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        overflow: visible;
      }
      .slot{
        width: 100%;
      }
      .actions{
        gap: 8px;
      }
      .primaryBtn, .ghostBtn{
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="shell">

      <header>
        <!-- ✅ 2-line stack container -->
        <div style="display:block; width:100%;">

          <!-- ✅ 1st line: header (kept) -->
          <div style="display:flex; align-items:center; justify-content:space-between; width:100%;">
            <a href="https://roleplay-chat.com" target="_blank" rel="noopener noreferrer" class="logo">
              <span class="logoRole">Roleplay-chat</span><span class="logoDot">.com</span>
            </a>

            <div class="shareWrap">
              <div class="bookmarkHint">
                Bookmark<br>&amp; Share
              </div>

              <button class="shareBtn" id="shareBtn" type="button" aria-label="Share" title="Share">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <circle cx="18" cy="5" r="3"></circle>
                  <circle cx="6" cy="12" r="3"></circle>
                  <circle cx="18" cy="19" r="3"></circle>
                  <path d="M8.6 13.5l6.8 3.9"></path>
                  <path d="M15.4 6.6L8.6 10.5"></path>
                </svg>
              </button>

              <button class="shareBtn" id="infoBtn" type="button" aria-label="Info" title="Info">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <circle cx="12" cy="12" r="9"></circle>
                  <path d="M12 10.5v6"></path>
                  <circle cx="12" cy="7.5" r="1"></circle>
                </svg>
              </button>

              <div class="infoMenu" id="infoMenu" role="menu" aria-label="Info menu">
                <a href="https://chat-with-stranger.com" target="_blank" rel="noopener noreferrer" style="color: #FF69B4; font-weight: bold; text-decoration: none;">Chat with stranger</a>
                <a href="https://roleplay-chat.com/human" target="_blank" rel="noopener noreferrer" style="color: #FFD700; font-weight: bold; text-decoration: none;">Chat with real human</a>
                <a href="https://roleplay-chat.com" target="_blank" rel="noopener noreferrer">Home</a>
                <a href="https://roleplay-chat.com/how" target="_blank" rel="noopener noreferrer">How to use</a>
                <a href="https://roleplay-chat.com/about" target="_blank" rel="noopener noreferrer">About</a>
                <a href="https://roleplay-chat.com/pricing" target="_blank" rel="noopener noreferrer">Pricing</a>
                <a href="https://roleplay-chat.com/all_access_purchase" target="_blank" rel="noopener noreferrer">All-access pass</a>
                <a href="https://roleplay-chat.com/policy" target="_blank" rel="noopener noreferrer">Policy</a>
                <a href="https://roleplay-chat.com/faq" target="_blank" rel="noopener noreferrer">FAQ</a>
                <a href="mailto:showmetheaitools@gmail.com">Contact</a>
                <a href="https://2048global.com" target="_blank" rel="noopener noreferrer" style="color: #FFD700; font-weight: bold; text-decoration: none;">Game</a>
                <a href="https://roleplay-chat.com/VPN" target="_blank" rel="noopener noreferrer" style="color: #FFD700; font-weight: bold; text-decoration: none;">VPN</a>
              </div>
            </div>
          </div>

          <!-- ✅ 2nd line: Chatango (kept) -->
          <div align="right">
            <sup>
              <a href="https://roleplay-chat.com/human" target="_blank" style="text-decoration:none">
                <font size="1" color="#ffcc00"><b>Live user chat</b></font>
              </a>
            </sup>

            <script
              id="cid0020000430144912743"
              data-cfasync="false"
              async
              src="https://st.chatango.com/js/gz/emb.js"
              style="width:200px;height:300px;"
            >
              {"handle":"roleplay-chat-com","arch":"js","styles":{"a":"000000","b":100,"c":"FFFFFF","d":"FFFFFF","k":"000000","l":"000000","m":"000000","n":"FFFFFF","p":"10","q":"000000","r":100,"cv":1,"cvfntsz":"10px","cvbg":"000000","cvfg":"ffcc00","cvw":49,"cvh":18}}
            </script>
          </div>

        </div>
      </header>

      <div class="sub">Create the most human-like character, Enjoy roleplay.<br>no-login. Private & Safe.</div>

      <!-- =========================
           Stitch page content
      ========================= -->
      <section class="panel" aria-label="Stitch videos">
        <div class="panelInner">
          <h1 class="heroTitle">
            Stitch your chat videos into one long video
            <span class="stitch"> — Stitch</span>
          </h1>
          <div class="heroSub">(Extend your Video Chat creations by stitching them into a longer video.)</div>

          <div class="chatLink">
            Want to create more clips first?
            <a href="https://roleplay-chat.com" target="_blank" rel="noopener noreferrer">Create videos in chat</a>
          </div>

          <div class="hintRow">
            <div class="miniHint">
              <b>MP4 only.</b> Add 2–10 clips in order, then press <b>Stitch</b>.<br>
              Tip: Drag & drop directly into slots.
            </div>
            <div class="statusPill" id="statusPill">Ready</div>
          </div>

          <div class="slotsWrap">
            <div class="slots" id="slots"></div>
          </div>

          <div class="actions">
            <button class="primaryBtn" id="stitchBtn" disabled>
              <span>Stitch</span>
              <span style="opacity:.75; font-size:12px;">(MP4)</span>
            </button>

            <button class="ghostBtn" id="resetBtn" type="button">Reset</button>

            <div style="flex:1 1 200px; min-width: 180px;">
              <div class="progressLine" id="progressLine" aria-label="Progress">
                <div class="progressFill" id="progressFill"></div>
              </div>
              <div style="margin-top:8px; color: rgba(255,255,255,.62); font-size:12px;" id="progressText"></div>
            </div>
          </div>

          <div class="finePrint">
            Stitching runs locally in your browser (no upload). Large files may take time or fail due to memory limits.
            Best results when clips share similar encoding settings.
          </div>
        </div>
      </section>

    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    // Share button
    const shareBtn = document.querySelector("#shareBtn");
    if (shareBtn){
      shareBtn.addEventListener("click", async () => {
        const url = window.location.href;
        try{
          if (navigator.share){
            await navigator.share({ title: document.title, url });
          }else{
            await navigator.clipboard.writeText(url);
            shareBtn.title = "Copied!";
            setTimeout(() => (shareBtn.title = "Share"), 900);
          }
        }catch(e){
          // cancelled / blocked
        }
      });
    }

    // Info menu
    const infoBtn = document.querySelector("#infoBtn");
    const infoMenu = document.querySelector("#infoMenu");
    function closeInfoMenu(){ if (infoMenu) infoMenu.classList.remove("active"); }
    if (infoBtn && infoMenu){
      infoBtn.addEventListener("click", (e) => { e.stopPropagation(); infoMenu.classList.toggle("active"); });
      infoMenu.addEventListener("click", (e) => e.stopPropagation());
      document.addEventListener("click", closeInfoMenu);
      document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeInfoMenu(); });
    }

    // =========================
    // Stitch App
    // =========================
    const MAX = 10;
    const slotsEl = document.getElementById("slots");
    const stitchBtn = document.getElementById("stitchBtn");
    const resetBtn = document.getElementById("resetBtn");
    const statusPill = document.getElementById("statusPill");
    const toast = document.getElementById("toast");
    const progressLine = document.getElementById("progressLine");
    const progressFill = document.getElementById("progressFill");
    const progressText = document.getElementById("progressText");

    // Slots data: { file: File|null, url: string|null, thumb: string|null }
    let openCount = 2; // start with 2 slots
    let items = Array.from({length: MAX}, () => ({ file: null, url: null, thumb: null, name: "" }));

    function showToast(msg, ms=2200){
      toast.innerHTML = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), ms);
    }

    function setStatus(text){
      statusPill.textContent = text;
    }

    function setProgress(pct, text){
      if (pct == null){
        progressLine.classList.remove("active");
        progressFill.style.width = "0%";
        progressText.textContent = "";
        return;
      }
      progressLine.classList.add("active");
      progressFill.style.width = `${Math.max(0, Math.min(100, pct))}%`;
      progressText.textContent = text || "";
    }

    function isMp4(file){
      // Some browsers provide empty type; fall back to extension
      const typeOk = (file.type || "").toLowerCase().includes("mp4");
      const nameOk = (file.name || "").toLowerCase().endsWith(".mp4");
      return typeOk || nameOk;
    }

    function cleanupItem(i){
      const it = items[i];
      if (it.url) URL.revokeObjectURL(it.url);
      items[i] = { file: null, url: null, thumb: null, name: "" };
    }

    async function makeThumbnail(file){
      // Create a quick thumbnail by seeking a hidden video and drawing to canvas
      const url = URL.createObjectURL(file);
      try{
        const v = document.createElement("video");
        v.src = url;
        v.muted = true;
        v.playsInline = true;
        v.preload = "metadata";

        await new Promise((res, rej) => {
          v.onloadedmetadata = () => res();
          v.onerror = () => rej(new Error("Video metadata error"));
        });

        // Seek slightly in
        const t = Math.min(0.12, (v.duration || 1) * 0.1);
        await new Promise((res, rej) => {
          v.currentTime = t;
          v.onseeked = () => res();
          v.onerror = () => rej(new Error("Video seek error"));
        });

        const canvas = document.createElement("canvas");
        const w = Math.max(240, v.videoWidth || 240);
        const h = Math.max(160, v.videoHeight || 160);
        // Keep it light: scale down
        const scale = Math.min(1, 320 / w);
        canvas.width = Math.round(w * scale);
        canvas.height = Math.round(h * scale);

        const ctx = canvas.getContext("2d");
        ctx.drawImage(v, 0, 0, canvas.width, canvas.height);

        const dataUrl = canvas.toDataURL("image/jpeg", 0.72);
        return { dataUrl, tempUrl: url };
      }catch(e){
        URL.revokeObjectURL(url);
        return { dataUrl: null, tempUrl: null };
      }
    }

    function countSelected(){
      return items.slice(0, openCount).filter(x => x.file).length;
    }

    function updateButtons(){
      const n = countSelected();
      stitchBtn.disabled = n < 2;
    }

    function render(){
      slotsEl.innerHTML = "";

      // Render open slots
      for (let i=0; i<openCount; i++){
        const it = items[i];

        const slot = document.createElement("div");
        slot.className = "slot";
        slot.dataset.idx = String(i);
        slot.setAttribute("role", "button");
        slot.setAttribute("tabindex", "0");
        slot.setAttribute("aria-label", `Slot ${i+1}`);

        const num = document.createElement("div");
        num.className = "slotNum";
        num.textContent = String(i+1);
        slot.appendChild(num);

        // hidden file input
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "video/mp4,.mp4";
        input.style.display = "none";
        input.addEventListener("change", async () => {
          const f = input.files && input.files[0];
          if (!f) return;
          await handleFile(i, f);
          input.value = "";
        });

        slot.appendChild(input);

        // Content
        if (it.file && it.thumb){
          const thumb = document.createElement("div");
          thumb.className = "thumb";
          thumb.style.backgroundImage = `url("${it.thumb}")`;
          slot.appendChild(thumb);

          const overlay = document.createElement("div");
          overlay.className = "thumbOverlay";
          slot.appendChild(overlay);

          const meta = document.createElement("div");
          meta.className = "fileMeta";

          const name = document.createElement("div");
          name.className = "fileName";
          name.textContent = it.name || "clip.mp4";

          const rm = document.createElement("button");
          rm.className = "removeBtn";
          rm.type = "button";
          rm.title = "Remove";
          rm.innerHTML = "✕";
          rm.addEventListener("click", (e) => {
            e.stopPropagation();
            cleanupItem(i);
            setStatus("Ready");
            showToast("Removed.");
            render();
          });

          meta.appendChild(name);
          meta.appendChild(rm);
          slot.appendChild(meta);
        }else{
          const label = document.createElement("div");
          label.className = "slotLabel";
          label.innerHTML = `
            <div style="font-weight:800; color: rgba(255,255,255,.86); margin-bottom:6px;">Tap / Drop MP4</div>
            <div style="color: rgba(255,255,255,.58); font-size:11px;">Slot ${i+1}</div>
          `;
          slot.appendChild(label);
        }

        // click opens picker
        slot.addEventListener("click", () => input.click());
        slot.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") { e.preventDefault(); input.click(); }
        });

        // drag & drop
        slot.addEventListener("dragover", (e) => {
          e.preventDefault();
          slot.classList.add("dragover");
        });
        slot.addEventListener("dragleave", () => slot.classList.remove("dragover"));
        slot.addEventListener("drop", async (e) => {
          e.preventDefault();
          slot.classList.remove("dragover");
          const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
          if (!f) return;
          await handleFile(i, f);
        });

        slotsEl.appendChild(slot);
      }

      // Plus slot if not max
      if (openCount < MAX){
        const plus = document.createElement("div");
        plus.className = "slot";
        plus.setAttribute("role", "button");
        plus.setAttribute("tabindex", "0");
        plus.setAttribute("aria-label", "Add slot");

        plus.innerHTML = `
          <div class="slotPlus">+</div>
          <div class="slotLabel" style="margin-top:6px;">Add another slot<br><span style="font-size:11px; color: rgba(255,255,255,.52);">Up to ${MAX} clips</span></div>
        `;

        plus.addEventListener("click", () => {
          openCount = Math.min(MAX, openCount + 1);
          showToast(`Slot ${openCount} added.`);
          render();
        });
        plus.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            openCount = Math.min(MAX, openCount + 1);
            showToast(`Slot ${openCount} added.`);
            render();
          }
        });

        slotsEl.appendChild(plus);
      }

      updateButtons();
    }

    async function handleFile(i, file){
      if (!isMp4(file)){
        setStatus("MP4 only");
        showToast(`<b>MP4 only.</b> Please upload an .mp4 file.`, 2600);
        return;
      }
      setStatus("Loading thumbnail...");
      // cleanup old
      cleanupItem(i);

      const { dataUrl, tempUrl } = await makeThumbnail(file);
      const url = tempUrl || URL.createObjectURL(file);

      items[i] = {
        file,
        url,
        thumb: dataUrl,
        name: file.name || `clip_${i+1}.mp4`
      };

      setStatus("Ready");
      showToast(`Added: <b>Slot ${i+1}</b>`);
      render();
    }

    // Reset
    resetBtn.addEventListener("click", () => {
      for (let i=0; i<MAX; i++) cleanupItem(i);
      openCount = 2;
      setProgress(null);
      setStatus("Ready");
      showToast("Reset done.");
      render();
    });

    // =========================
    // FFmpeg Stitch (browser)
    // =========================
    let ffmpeg = null;
    let ffmpegLoaded = false;

    async function loadFFmpeg(){
      if (ffmpegLoaded) return;
      setStatus("Loading FFmpeg...");
      setProgress(3, "Loading Stitch engine...");

      // Use ESM modules from jsDelivr (works well on HTTPS)
      // Single-thread core (no crossOriginIsolated requirement)
      const { FFmpeg } = await import("https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.15/dist/esm/index.js");
      const { toBlobURL, fetchFile } = await import("https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.2/dist/esm/index.js");

      ffmpeg = new FFmpeg();

      // Optional logs (silent by default)
      ffmpeg.on("progress", ({ progress }) => {
        // progress is 0..1
        const pct = Math.round(progress * 100);
        setProgress(Math.max(8, pct), `Stitching... ${pct}%`);
      });

      const baseURL = "https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.10/dist/esm";
      await ffmpeg.load({
        coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, "text/javascript"),
        wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, "application/wasm"),
      });

      // store helper
      loadFFmpeg.fetchFile = fetchFile;

      ffmpegLoaded = true;
      setProgress(null);
      setStatus("Ready");
      showToast("Stitch engine loaded.");
    }

    function getSelectedFiles(){
      // Keep order by slot index. Ignore empty ones.
      return items.slice(0, openCount).map((x, idx) => ({...x, idx})).filter(x => x.file);
    }

    stitchBtn.addEventListener("click", async () => {
      const selected = getSelectedFiles();
      if (selected.length < 2){
        showToast("Add at least <b>2</b> MP4 clips.");
        return;
      }

      stitchBtn.disabled = true;
      resetBtn.disabled = true;

      try{
        await loadFFmpeg();

        setStatus("Stitching...");
        setProgress(6, "Preparing files...");

        // Write files into FFmpeg FS
        // We'll concat via demuxer with safe=0
        // For best compatibility we re-mux to mp4 (copy) or re-encode if needed.
        // Start with fast attempt: stream copy
        const listLines = [];
        for (let k=0; k<selected.length; k++){
          const it = selected[k];
          const inName = `in_${k+1}.mp4`;
          const data = await loadFFmpeg.fetchFile(it.file);
          await ffmpeg.writeFile(inName, data);
          listLines.push(`file '${inName}'`);
        }
        await ffmpeg.writeFile("concat.txt", new TextEncoder().encode(listLines.join("\n")));

        setProgress(10, "Stitching...");

        // Fast path: copy streams (works if codecs/params compatible)
        // If it fails, fallback to re-encode.
        let usedFallback = false;

        try{
          await ffmpeg.exec([
            "-f","concat","-safe","0",
            "-i","concat.txt",
            "-c","copy",
            "output.mp4"
          ]);
        }catch(err){
          usedFallback = true;
          // fallback: re-encode to H.264/AAC for compatibility
          setProgress(12, "Compatibility mode (re-encoding)...");
          await ffmpeg.exec([
            "-f","concat","-safe","0",
            "-i","concat.txt",
            "-c:v","libx264",
            "-preset","veryfast",
            "-crf","23",
            "-c:a","aac",
            "-b:a","192k",
            "-movflags","+faststart",
            "output.mp4"
          ]);
        }

        setProgress(96, "Finalizing...");

        const out = await ffmpeg.readFile("output.mp4");
        const blob = new Blob([out.buffer], { type: "video/mp4" });
        const dlUrl = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = dlUrl;
        a.download = `stitched_${selected.length}_clips.mp4`;
        document.body.appendChild(a);
        a.click();
        a.remove();

        // Cleanup object URL later
        setTimeout(() => URL.revokeObjectURL(dlUrl), 8000);

        setProgress(null);
        setStatus("Completed");
        showToast(`<b>Completed.</b> Download started. ${usedFallback ? " (Compatibility mode used)" : ""}`, 3200);
      }catch(e){
        console.error(e);
        setProgress(null);
        setStatus("Error");
        showToast(`<b>Error.</b> Try smaller clips or fewer files.`, 3200);
      }finally{
        resetBtn.disabled = false;
        updateButtons();
      }
    });

    // Initial render
    render();
  </script>
</body>
</html>
